// FilmoRent - Schemat bazy danych
// Docs: https://dbml.dbdiagram.io/docs
// System wypożyczalni sprzętu filmowego i fotograficznego

// ==========================================
// GRUPA 1: Użytkownicy i Uprawnienia (Auth)
// ==========================================

Table role {
  id bigint [primary key, increment]
  nazwa varchar(50) [not null, note: 'Wyświetlana nazwa roli (np. Administrator)']
  klucz varchar(50) [unique, not null, note: 'Identyfikator systemowy (admin, pracownik, klient)']
}

Table uzytkownicy {
  id bigint [primary key, increment]
  rola_id bigint [not null, ref: > role.id]
  imie varchar(100) [not null]
  nazwisko varchar(100) [not null]
  email varchar(255) [unique, not null]
  haslo varchar(255) [not null, note: 'Hash hasła (Bcrypt/Argon2)']
  telefon varchar(20)
  zweryfikowany_email_data timestamp
  remember_token varchar(100)
  utworzono_data timestamp [default: `now()`]
  zaktualizowano_data timestamp

  indexes {
    email
    rola_id
  }
}

Table adresy {
  id bigint [primary key, increment]
  uzytkownik_id bigint [not null, ref: > uzytkownicy.id]
  ulica varchar(255) [not null]
  miasto varchar(100) [not null]
  kod_pocztowy varchar(20) [not null, note: 'Format XX-XXX']
  typ enum('rozliczeniowy', 'dostawy') [not null]

  indexes {
    uzytkownik_id
  }
}

// ==========================================
// GRUPA 2: Inwentarz (Inventory)
// ==========================================

Table kategorie {
  id bigint [primary key, increment]
  nazwa varchar(100) [not null, note: 'np. Kamery Cyfrowe, Obiektywy']
  slug varchar(100) [unique, not null, note: 'Przyjazny URL (kamery-cyfrowe)']
  rodzic_id bigint [ref: > kategorie.id, note: 'Relacja zwrotna - drzewo kategorii']

  indexes {
    rodzic_id
  }
}

Table producenci {
  id bigint [primary key, increment]
  nazwa varchar(100) [not null, note: 'Sony, Canon, Blackmagic Design']
  opis text
}

Table sprzet {
  id bigint [primary key, increment]
  kategoria_id bigint [not null, ref: > kategorie.id]
  producent_id bigint [not null, ref: > producenci.id]
  nazwa varchar(255) [not null, note: 'np. Sony Alpha a7S III Body']
  numer_seryjny varchar(100) [unique, not null, note: 'Krytyczne dla ubezpieczyciela']
  opis text
  cena_doba decimal(10,2) [not null, note: 'Stawka netto za 24h']
  kaucja decimal(10,2) [not null, note: 'Zabezpieczenie przy wydaniu']
  wartosc_rynkowa decimal(10,2) [not null, note: 'Wartość odtworzeniowa']
  status_sprzetu enum('dostepny', 'w_serwisie', 'wycofany', 'zaginiony') [default: 'dostepny']
  utworzono_data timestamp [default: `now()`]
  zaktualizowano_data timestamp

  indexes {
    kategoria_id
    producent_id
    numer_seryjny
    status_sprzetu
  }
}

// ==========================================
// GRUPA 3: Transakcje i Wypożyczenia (Core)
// ==========================================

Table statusy_wypozyczenia {
  id bigint [primary key, increment]
  nazwa varchar(50) [not null, note: 'np. Oczekuje, Wydane, Zwrócone']
  klucz varchar(50) [unique, not null, note: 'Identyfikator do kodu']
  kolor varchar(20) [note: 'Kolor do wyświetlania w UI']
}

Table wypozyczenia {
  id bigint [primary key, increment]
  numer_zamowienia varchar(50) [unique, not null, note: 'np. RENT/2025/01/0001']
  uzytkownik_id bigint [not null, ref: > uzytkownicy.id, note: 'Klient']
  pracownik_id bigint [ref: > uzytkownicy.id, note: 'Kto wydał sprzęt']
  status_id bigint [not null, ref: > statusy_wypozyczenia.id]
  data_rezerwacji datetime [not null]
  data_odbioru datetime [not null, note: 'Planowany początek najmu']
  data_zwrotu datetime [not null, note: 'Planowany koniec najmu']
  faktyczna_data_zwrotu datetime [note: 'Do naliczania kar za opóźnienie']
  suma_calkowita decimal(10,2) [not null]
  uwagi text
  utworzono_data timestamp [default: `now()`]
  zaktualizowano_data timestamp

  indexes {
    uzytkownik_id
    pracownik_id
    status_id
    data_odbioru
    data_zwrotu
  }
}

Table elementy_wypozyczenia {
  id bigint [primary key, increment]
  wypozyczenie_id bigint [not null, ref: > wypozyczenia.id]
  sprzet_id bigint [not null, ref: > sprzet.id]
  cena_netto_snapshot decimal(10,2) [not null, note: 'Cena w momencie wypożyczenia']
  rabat_procent int [default: 0]

  indexes {
    wypozyczenie_id
    sprzet_id
    (wypozyczenie_id, sprzet_id) [unique]
  }
}

// ==========================================
// GRUPA 4: Finanse i Pliki (Support)
// ==========================================

Table platnosci {
  id bigint [primary key, increment]
  wypozyczenie_id bigint [not null, ref: > wypozyczenia.id]
  kwota decimal(10,2) [not null]
  typ enum('zaliczka', 'oplata_koncowa', 'kaucja', 'zwrot_kaucji', 'kara') [not null]
  metoda enum('przelew', 'gotowka', 'karta', 'blik') [not null]
  status enum('oczekujaca', 'zrealizowana', 'odrzucona') [not null]
  zewnetrzne_id varchar(255) [note: 'ID transakcji z PayU/Stripe']
  utworzono_data timestamp [default: `now()`]

  indexes {
    wypozyczenie_id
    status
  }
}

Table zalaczniki {
  id bigint [primary key, increment]
  sciezka varchar(255) [not null, note: 'Ścieżka w storage']
  nazwa_oryginalna varchar(255) [not null]
  typ_mime varchar(50) [not null, note: 'image/jpeg, application/pdf']
  opis_alternatywny varchar(255) [note: 'Alt text dla WCAG']
  model_type varchar(255) [not null, note: 'Polimorfizm: App\\Models\\Sprzet lub Wypozyczenie']
  model_id bigint [not null]
  utworzono_data timestamp [default: `now()`]

  indexes {
    (model_type, model_id)
  }
}

// ==========================================
// Relacje polimorficzne (załączniki)
// ==========================================
// Załączniki mogą być podpięte do:
// - sprzet (zdjęcia sprzętu)
// - wypozyczenia (skany umów, protokoły zdawczo-odbiorcze)
